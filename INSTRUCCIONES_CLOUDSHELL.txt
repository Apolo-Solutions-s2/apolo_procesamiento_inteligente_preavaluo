================================================================================
  SCRIPT √öNICO PARA CLOUD SHELL - COPIAR Y PEGAR
================================================================================

ARCHIVO A COPIAR:
  scripts/deploy-cloudshell.sh

PASOS:
  1. Abre el archivo: scripts/deploy-cloudshell.sh
  2. Selecciona TODO el contenido (Ctrl+A)
  3. Copia (Ctrl+C)
  4. Ve a Google Cloud Console ‚Üí Cloud Shell
  5. Pega (Ctrl+Shift+V o clic derecho ‚Üí Paste)
  6. Presiona Enter
  7. Cuando pregunte "¬øContinuar con este proyecto?" ‚Üí responde: s

================================================================================

CONFIGURACI√ìN AUTOM√ÅTICA:

  ‚úì Regi√≥n:               us-south1 (Dallas, Texas)
  ‚úì Base de datos:        apolo-preavaluos-dev
  ‚úì Colecci√≥n Firestore:  apolo_procesamiento
  ‚úì Bucket GCS:           preavaluos-pdf
  ‚úì Servicio Cloud Run:   apolo-procesamiento-inteligente

  NO NECESITAS CAMBIAR NADA - TODO EST√Å CONFIGURADO AUTOM√ÅTICAMENTE

================================================================================

LO QUE HACE EL SCRIPT (AUTOM√ÅTICO):

  [Paso 1] Habilita APIs de GCP
           ‚Ä¢ Cloud Run, Cloud Build, Storage, Firestore

  [Paso 2] Crea bucket GCS
           ‚Ä¢ Nombre: preavaluos-pdf
           ‚Ä¢ Regi√≥n: us-south1
           ‚Ä¢ Versionado habilitado

  [Paso 3] Configura Firestore
           ‚Ä¢ Base de datos: apolo-preavaluos-dev
           ‚Ä¢ Regi√≥n: us-south1
           ‚Ä¢ Colecci√≥n: apolo_procesamiento (se crea autom√°ticamente)

  [Paso 4] Clona c√≥digo desde GitHub
           ‚Ä¢ Repositorio: apolo_procesamiento_inteligente_preavaluo

  [Paso 5] Construye imagen Docker
           ‚Ä¢ Con Cloud Build
           ‚Ä¢ Sube a Container Registry

  [Paso 6] Despliega a Cloud Run
           ‚Ä¢ Memoria: 512MB
           ‚Ä¢ CPU: 1
           ‚Ä¢ Timeout: 300s
           ‚Ä¢ Autoscaling: 0-10 instancias
           ‚Ä¢ Regi√≥n: us-south1 (Dallas)

  [Paso 7] Crea datos de prueba
           ‚Ä¢ 3 PDFs de ejemplo en GCS

  [Paso 8] Ejecuta 5 tests autom√°ticos
           ‚Ä¢ Health check
           ‚Ä¢ Procesamiento individual
           ‚Ä¢ Procesamiento batch
           ‚Ä¢ Idempotencia (cache)
           ‚Ä¢ Manejo de errores

  [Paso 9] Muestra resultado
           ‚Ä¢ URL del servicio
           ‚Ä¢ Comandos √∫tiles
           ‚Ä¢ Links a consolas web

================================================================================

TIEMPO DE EJECUCI√ìN: 5-7 minutos

COSTO: ~$0 (usa free tier de GCP)

================================================================================

DESPU√âS DEL DESPLIEGUE:

El script te dar√° la URL del servicio:
  https://apolo-procesamiento-inteligente-xxxxx-uc.a.run.app

GUARDA ESTA URL - la necesitas para hacer requests desde tu aplicaci√≥n.

================================================================================

PROBAR EL SERVICIO:

1. Sube un PDF:
   gsutil cp mi_documento.pdf gs://preavaluos-pdf/MI-FOLIO-001/

2. Proc√©salo:
   curl -X POST "https://TU_SERVICIO.run.app" \
     -H "Content-Type: application/json" \
     -d '{
     "folioId": "MI-FOLIO-001",
     "fileId": "mi_documento.pdf",
     "gcs_pdf_uri": "gs://preavaluos-pdf/MI-FOLIO-001/mi_documento.pdf",
     "workflow_execution_id": "test-123"
   }'

3. Verifica en Firestore:
   ‚Ä¢ Base de datos: apolo-preavaluos-dev
   ‚Ä¢ Colecci√≥n: apolo_procesamiento
   ‚Ä¢ Busca el documento por folio_id

================================================================================

CONSOLAS WEB (despu√©s del despliegue):

Cloud Run:
  https://console.cloud.google.com/run/detail/us-south1/apolo-procesamiento-inteligente

Firestore:
  https://console.firebase.google.com/project/[PROJECT_ID]/firestore/databases/apolo-preavaluos-dev

Cloud Storage:
  https://console.cloud.google.com/storage/browser/preavaluos-pdf

Logs:
  https://console.cloud.google.com/logs/query

================================================================================

COMANDOS √öTILES (desde Cloud Shell):

Ver logs en tiempo real:
  gcloud run services logs tail apolo-procesamiento-inteligente --region=us-south1

Ver √∫ltimos 50 logs:
  gcloud run services logs read apolo-procesamiento-inteligente --region=us-south1 --limit=50

Ver documentos en Firestore:
  gcloud firestore documents list --database=apolo-preavaluos-dev --collection-ids=apolo_procesamiento

Redesplegar (despu√©s de cambios):
  cd apolo_procesamiento_inteligente_preavaluo
  gcloud builds submit --tag=gcr.io/$PROJECT_ID/apolo-procesamiento-inteligente .
  gcloud run deploy apolo-procesamiento-inteligente \
    --image=gcr.io/$PROJECT_ID/apolo-procesamiento-inteligente \
    --region=us-south1

================================================================================

GU√çAS ADICIONALES:

  üìñ Gu√≠a Ejecutiva:     DESPLIEGUE_DALLAS.md
  üìñ Gu√≠a Detallada:     scripts/CLOUDSHELL_DEPLOY.md
  üìñ Documentaci√≥n:      docs/

================================================================================

CHECKLIST R√ÅPIDO:

Antes de ejecutar:
  [ ] Estoy en Google Cloud Console
  [ ] Tengo Cloud Shell abierto
  [ ] Tengo permisos de Editor/Owner

Durante la ejecuci√≥n:
  [ ] Copi√© TODO el script deploy-cloudshell.sh
  [ ] Pegu√© en Cloud Shell
  [ ] Respond√≠ 's' cuando pregunt√≥

Despu√©s del despliegue:
  [ ] Guard√© la URL del servicio
  [ ] Verifiqu√© Firestore (base de datos: apolo-preavaluos-dev)
  [ ] Prob√© con un PDF de prueba

================================================================================

ESTRUCTURA DE RESPUESTA (√âxito):

{
  "status": "processed",
  "preavaluo_id": "PRE-2025-001",
  "document_count": 1,
  "results": [
    {
      "file_name": "balance_general.pdf",
      "gcs_uri": "gs://preavaluos-pdf/PRE-2025-001/balance_general.pdf",
      "classification": {
        "document_type": "BalanceGeneral",
        "confidence": 0.95
      },
      "extraction": {
        "fields": {...},
        "metadata": {...}
      },
      "processed_at": "2025-12-04T14:30:00Z",
      "from_cache": false
    }
  ]
}

================================================================================

PROCESAMIENTO BATCH (carpeta completa):

Request:
{
  "folder_prefix": "PRE-2025-001/",
  "preavaluo_id": "PRE-2025-001",
  "extensions": [".pdf"],
  "max_items": 500,
  "workflow_execution_id": "test-batch-123"
}

El servicio procesa TODOS los PDFs en la carpeta autom√°ticamente.

================================================================================

FIRESTORE - ESTRUCTURA DE DOCUMENTOS:

Base de datos: apolo-preavaluos-dev
Colecci√≥n:     apolo_procesamiento
Document ID:   Hash SHA-256 de "folioId:fileId" (16 caracteres)

Campos guardados:
  ‚Ä¢ doc_id
  ‚Ä¢ folio_id
  ‚Ä¢ file_id
  ‚Ä¢ gcs_uri
  ‚Ä¢ run_id
  ‚Ä¢ status (completed/failed/processing)
  ‚Ä¢ classification {...}
  ‚Ä¢ extraction {...}
  ‚Ä¢ processing_started_at
  ‚Ä¢ processed_at
  ‚Ä¢ updated_at

IDEMPOTENCIA:
  Si re-procesas el mismo documento ‚Üí respuesta desde cache
  Campo en respuesta: "from_cache": true

================================================================================

SOLUCI√ìN DE PROBLEMAS:

"Project not set":
  gcloud config set project TU_PROJECT_ID

"Permission denied":
  Necesitas roles: Editor, Owner, Run Admin, Storage Admin, Datastore Owner

Servicio no responde:
  gcloud run services logs tail apolo-procesamiento-inteligente --region=us-south1

================================================================================

TODO LISTO PARA COPIAR Y PEGAR EN CLOUD SHELL

Archivo: scripts/deploy-cloudshell.sh

¬°√âxito con tu despliegue! üöÄ

================================================================================
