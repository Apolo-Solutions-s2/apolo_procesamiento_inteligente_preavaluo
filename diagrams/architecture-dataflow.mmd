flowchart LR

    EVENT["Eventarc<br/>object.finalize<br/>'is_ready' file"]

    CR["Cloud Run Service<br/>Procesamiento Inteligente"]

    GCS["Cloud Storage<br/>PDF/A Files"]

    CLASS["Document AI Classifier<br/>(us-south1)"]
    EXTR["Document AI Extractor<br/>(us-south1)"]

    FS_folios["Firestore<br/>folios/{folioId}"]
    FS_docs["Firestore<br/>folios/{folioId}/documentos/{docId}"]
    FS_extr["Firestore<br/>folios/{folioId}/documentos/{docId}/extracciones/{extractionId}"]

    DLQ["Pub/Sub DLQ"]

    LOGS["Cloud Logging<br/>structured logs"]

    %% Flow
    EVENT --> CR

    CR -->|list PDFs in folder| GCS
    CR -->|download PDF| GCS

    CR -->|classify document| CLASS
    CR -->|extract data| EXTR

    CR -->|write folio metadata| FS_folios
    CR -->|write doc results| FS_docs
    CR -->|write extraction data| FS_extr

    CR -->|structured logs| LOGS

    CR -->|on persistent failure| DLQ

    CLASS --> CR
    EXTR --> CR
